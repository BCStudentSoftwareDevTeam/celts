{%set title ="User Profile"%}
{% extends "base.html"%}

{% block scripts %}
  {{super()}}
  <script type="text/javascript" src="{{url_for('static', filename='js/userProfile.js') }}?u={{lastStaticUpdate}}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/3.3.4/jquery.inputmask.bundle.min.js"></script>
{% endblock %}

{% block styles %}
  {{super()}}
  <link rel="stylesheet" href="{{url_for('static', filename ='css/userProfile.css') }}?u={{lastStaticUpdate}}">
{% endblock %}

{% block app_content %}
<div>
    <h1 align="center">{{volunteer.firstName}} {{volunteer.lastName}}</h1>
    <h6 align="center">{{volunteer.email}}</h6>
    <div align="center">
          <input type="text" style="border: none" size="14" class="form-control-sm bfh-phone"  id="phoneInput" value="{{volunteer.phoneNumber}}" placeholder="Phone Number" />
          <a class="text-decoration-none primary editButton" id="updatePhone" data-username="{{volunteer.username}}" type="button">Edit</a>
    </div>
</div>
<!-- Start Upcoming Events -->
<div class="accordion" id="userProfile">
  <div class="accordion-item">
    <h3 class="accordion-header" id="headingOne">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="collapseOne" aria-expanded="true" aria-controls="collapseOne">
        Upcoming Events
      </button>
    </h3>
    {% set collapse="show" %}
    {% if showPane %}
      {% set collapse= "" %}
    {% endif %}
    <div id="collapseOne" class="accordion-collapse collapse {{collapse}}" aria-labelledby="headingOne" data-bs-parent="#userProfile">
      <div class="accordion-body">
        <div class="row table-responsive">
          <table class="table">
            {% if upcomingEvents|length > 0 %}
              <thead class="tableHeader">
                <th scope="col">Program</th>
                <th scope="col">Event Name</th>
                <th scope="col">Event Date</th>
                <th scope="col">Time</th>
                <th scope="col">Location</th>
                <th scope="col">RSVP Status</th>
              </thead>
              {% for event in upcomingEvents %}
              <tr class="{% if event.startDate == currentDateTime.date() and event.timeStart < currentDateTime.time() %} ongoing-event {% endif %}{% if event.startDate == currentDateTime.date() and not event.timeStart < currentDateTime.time() %} bg-info {% endif %}">
                    <td>{{event.singleProgram.programName if event.singleProgram else '--'}}</td>
                    <td><a href= '/eventsList/{{event.id}}/view' class="link-primary">{{event.name}}</a></td>
                    <td nowrap>{{event.startDate.strftime('%m/%d/%Y')}}</td>
                    <td nowrap>{{event.timeStart.strftime('%-I:%M %p')}}</td>
                    <td>{{event.location}}</td>
                    <td>{{"RSVP'ed" if event.id in rsvpedEvents else "Not RSVP'ed"}}</td>
                  </tr>
              {% endfor %}
            {% else %}
              <h5>You have no upcoming events.</h5>
            {% endif %}
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- End Upcoming Events -->
  <!-- Start Program History -->
  <div class="accordion-item">
    <h3 class="accordion-header" id="headingTwo">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
          Participation History
      </button>
    </h3>
    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#userProfile">
      <div class="accordioin-body">
        <div class="row table-responsive">
          <table class="table">
            {% if participatedEvents|length > 0 %}
              <thead class="tableHeader">
                <th scope="col">Program</th>
                <th scope="col">Event Name</th>
                <th scope="col">Event Date</th>
              </thead>
              {% for event in participatedEvents %}
              <tr>
                <td>{{event.programName}}</td>
                <td><a href= '/eventsList/{{event.id}}/view' class="link-primary">{{event.name}}</a></td>
                <td nowrap>{{event.startDate.strftime('%m/%d/%Y')}}</td>
              </tr>
              {% endfor %}
            {% else %}
              <h5>You have not participated in any events.</h5>
            {% endif %}
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- End Program History -->
  <!-- Start Program Eligibility Table -->
  <div class="accordion-item">
    <h3 class="accordion-header" id="headingThree">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
          Interests
      </button>
    </h3>
    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#userProfile">
      <div class="accordioin-body">
        <div class="table-responsive">
         <h5>Choose interests below to be notified about your upcoming events:</h5>
          <table class="table banTable">
             <thead>
               <tr>
                 <th scope="col">Program</th>
                 <th scope="col">Notify</th>
                 <th scope="col">Training</th>
                 {% if g.current_user.isCeltsAdmin or g.current_user.isCeltsStudentStaff%}
                   <th scope="col">Eligibility</th>
                 {% endif %}
                 <th scope="col"></th>
               </tr>
             </thead>
             <tbody>
             {% for row in eligibilityTable %}
             {% set trainingList = row['trainingList'] %}
             {% macro trainingListView() %}
               {% if trainingList %}
                   {% for trainings, participated in trainingList.items() %}
                       {% if g.current_user.isCeltsAdmin %}
                         <li>{{trainings}}</li>
                       {% else %}
                           {% if participated == 1 %}
                               <p><b>{{trainings}}</b>: <br>Attended</p>
                           {% elif participated == 0 %}
                               <p><b>{{trainings}}</b>: <br>Not attended</p>
                           {% elif not participated[0] %}
                               <p><b>{{trainings}}</b>: <br>Takes place on {{participated[1]}}</p>
                           {% endif%}
                       {% endif %}
                   {% endfor %}
               {% else %}
                   <p>No trainings for this program.</p>
               {% endif %}
             {% endmacro %}
               {% set checked = "" %}
               {% if row.program in programsInterested %}
                   {% set checked = "checked" %}
               {% endif %}
                 <tr>
                   <td><a href="{{row.program.url}}" id="programNameTable">{{row.program.programName}}</a></td>
                   <td><input class="form-check-input" type="checkbox" data-programid="{{row.program.id}}" data-username="{{volunteer.username}}" {{checked}}></td>
                   <td>
                       {% if row.completedTraining or not trainingList %}
                           <i class="bi bi-check-lg"></i> &nbsp&nbsp
                           <a class="trainingPopover" id="{{row.program.id}}" href="#" data-toggle="popover" title="Program Trainings" data-content= "{{trainingListView()}}">View</a>
                       {% else %}
                           <i class="bi bi-x-lg"></i> &nbsp&nbsp
                           <a class="trainingPopover" id="{{row.program.id}}" href="#" data-toggle="popover" title="Program Trainings" data-content= "{{trainingListView()}}">View</a>
                       {% endif %}
                   </td>
                 {% if g.current_user.isCeltsAdmin or g.current_user.isCeltsStudentStaff %}
                     {% if row.isNotBanned %}
                       <td class="programBan">
                         {% set label = "Ban" %}
                         Eligible
                     {% else %}
                       <td class="programBan text-danger">
                         {% set label = "Unban" %}
                           Banned
                     {% endif %}
                   </td>
                   <td>
                   {% if g.current_user.isCeltsAdmin %}
                       <button type="button" class="ban btn btn-primary" data-programid="{{row.program.id}}" data-name="{{row.program.programName}}" data-note="{{row.banNote}}" value="{{label}}">Edit</button>
                   {% endif %}
                   </td>
                 {% endif %}

             </tr>
           {% endfor %}
           </tbody>
       </table>
       <a href="https://www.berea.edu/celts/community-service-programs/volunteer-opportunities/">For more information about CELTS opportunities, click here.</a>
       </div>
      </div>
    </div>
  </div>
  <!-- End Program Eligibility Table -->
  <!-- Start Program Manager section -->
  {% if g.current_user.isCeltsAdmin or g.current_user.isCeltsStudentStaff %}
    <div class="accordion-item">
      <h3 class="accordion-header" id="headingFour">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
            Program Manager
        </button>
      </h3>
      <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#userProfile">
        <div class="accordioin-body">
          {% if g.current_user.isCeltsAdmin%}
          <!-- This makes sure that the CeltsAdmins can make someone program manager or not.  -->
            {% if volunteer.isCeltsStudentStaff%}
                <div class="row">
                  <h2>Which programs do you want to make {{volunteer.firstName}} {{volunteer.lastName}} manager for?</h2>
                  <ul class="list-unstyled">
                    {% for program in programs %}
                      {% set action = "add" %}
                      {% set checked = "" %}
                      {% if program.id in permissionPrograms %}
                            {% set action = "remove" %}
                            {% set checked = "checked" %}
                      {% endif %}
                      <li>
                          <input  type="checkbox" id="mgr-{{ program.id }}" data-programid="{{program.id}}" {{checked}}  onclick="updateManagers(this,'{{volunteer.username}}')">
                          <label  style="padding-left: 15px;" for="mgr-{{ program.id }}">{{program.programName}}</label>
                      </li>
                    {% endfor %}
                </ul>
                </div>
                <br>
              {% endif %}

          {% elif volunteer.isCeltsStudentStaff %}
            <div class="row">
              <h2><br>{{volunteer.firstName}} {{volunteer.lastName}} is the manager of:</h2>
              <div>
                  <ul>
                  {% for program in programs %}
                    {% set status = '' %}
                      {% if program.id in permissionPrograms %}
                         <li>{{program.programName}}</li>
                      {% else %}
                      {% endif %}
                  {% endfor %}
                  </ul>
              </div>
            </div>
          <br>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
    <!-- End Program Manager section -->
    <!-- Start Background Check Table -->
    {% if g.current_user.isAdmin %}
    <div class="accordion-item">
      <h3 class="accordion-header" id="headingFive">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
            Background Check
        </button>
      </h3>
      <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#userProfile">
        <div class="accordioin-body">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">Description</th>
                   {% if g.current_user.isCeltsAdmin%}
                   <th scope="col">Status</th>
                   <th scope="col">Date</th>
                      <th class="" id="displaySave" scope="col"></th>
                   {% endif %}
                 </tr>
               </thead>
               <tbody>
                 {% for bgType in backgroundTypes %}
                 <tr>
                   <td>
                       <h6>{{bgType.description}}</h6>
                       <div>
                           {% if allEntries[bgType.id][0] %}
                              Status: {{allEntries[bgType.id][0][0]}} as of {{allEntries[bgType.id][0][1]}} &nbsp&nbsp<a id="-{{bgType.id}}" type='button' onclick="showHistory(this)" href="#">History</a>
                           {% else %}
                              Not Submitted
                           {% endif %}
                       </div>
                   </td>
                   {% if g.current_user.isCeltsAdmin %}
                      <td>
                          <select class="passedBackgroundCheck" id="{{bgType.id}}" data-id="{{bgType.id}}">
                              <option value=''></option>
                              <option value="Submitted">Submitted</option>
                              <option value="Passed">Passed</option>
                              <option value="Failed">Failed</option>
                          </select>
                      </td>
                      <td><input name="dateCompleted" type="date" id="{{bgType.id}}_date" class="form-control"/></td>
                      <td><button type="button" class="savebtn btn btn-primary" id="{{bgType.id}}" data-id="{{bgType.id}}" data-username="{{volunteer.username}}">Save</button></td>
                  {% endif %}
                  </tr>
                {%endfor%}
               </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
    <!-- End Background Check Table -->
  </div>

<!-- Ban or Unban Modal -->
{% for type in backgroundTypes %}
    <div class="modal fade" id="historyModal-{{type.id}}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Background Check History for </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <table class="table">
                 <thead>
                   <tr>
                     <th scope="col">Status</th>
                     <th scope="col">Date</th>
                   </tr>
                 </thead>
                 <tbody>
                   {% for entry in allEntries[type.id] %}
                   <tr>
                     <td>
                        {% if loop.index == 1%}
                            <h6>{{entry[0]}}</h6>
                        {% else %}
                            {{entry[0]}}
                        {% endif %}

                     </td>
                     <td>
                         {% if loop.index == 1%}
                            <h6>{{entry[1]}}</h6>
                         {% else %}
                            {{entry[1]}}
                         {% endif %}
                     </td>
                    </tr>
                  {% endfor %}
                 </tbody>
              </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
{% endfor %}
{% endblock %}
